function FillTable_CMCDATA(settings){var opt={muteHttpExceptions:!0};Logger.log("CMC cache 1. => direct file access");var mycache=UrlFetchApp.fetch("https://drive.google.com/uc?export=download&id=1e4QwD32tqAiipZeRP5zRIaNnahFVk6KP",opt);if(200===mycache.getResponseCode())return JSON.parse(mycache.getContentText());Logger.log("CMC cache 2. => webapp call");var mycache=UrlFetchApp.fetch("https://script.google.com/macros/s/AKfycbycDVnFImK8f6SZme1MJL3qhY3agbsWWXrcbfgw/exec?ID=1e4QwD32tqAiipZeRP5zRIaNnahFVk6KP",opt);if(200===mycache.getResponseCode())return JSON.parse(mycache.getContentText());Logger.log("CMC cache 3. => drive app");try{return eval('var mycache = DriveApp.getFileById("1e4QwD32tqAiipZeRP5zRIaNnahFVk6KP").getBlob().getDataAsString();'),JSON.parse(mycache)}catch(e){Logger.log("no drive app")}var cont=!0;do{try{var mycache=UrlFetchApp.fetch("https://drive.google.com/uc?export=download&id=1e4QwD32tqAiipZeRP5zRIaNnahFVk6KP"),result,cont;200===mycache.getResponseCode()?(result=JSON.parse(mycache.getContentText()),cont=!1):Logger.log(Utilities.formatString("Request failed. Expected 200, got %d: %s",responseCode,responseBody))}catch(e){DebugLog("CoinMarketCap failed","This is due to a Google bug. Retry ....(alternatively Enable Drive_App autorisation).")}}while(1==cont);return result}function Profile1(e){ExecProf(e,"Profile1")}function Profile2(e){ExecProf(e,"Profile2")}function ExecProf(e,t){VERBOSE="YES",e.balance==t&&CoreUpdate(e),e.onetoonematch==t&&OnetoOneMatch(e),e.countermatch==t&&CounterMatch(e),e.calcunmatched==t&&CalcUnmatchedOrders(e),e.markets==t&&UpdateMarketsSheet(e)}function CoreUpdate(e){if(0==UpdateBalanceSheet(e))return null;DebugLog("Auto detected changes in Balance + Force Symbols Setting",e.symbols),null!=e.symbols&&(UpdateOrderHistorySheet(e,"Exchange"),UpdateDepositSheet(e),UpdateWithdrawalSheet(e),TimestampCell("CONFIG!$C$2"))}function ExitMessage(e,t){DebugLog("Process Finished","Debug mode can be turned on/off in CONFIG");try{!1===t.status&&""!=t.message&&DebugLog("Failed",t.message)}catch(e){Logger.log("exit")}}function AddStringToNow(e){return moment().subtract(Number(e.substring(e.indexOf(" "),0)),e.substring(e.indexOf(" ")+1,e.length)).format("YYYY/MM/DD HH:mm:mm")}function FirstTimeRunner(e){UpdateMarketsSheet(e),"yes"==Browser.msgBox("WELCOME TO BOTMON\\n\\nThis is the first time you run the script on a blank sheet.\\n\\nCan we set the recommended Triggers so BotMon can \\n automatically pull data from "+e.exchangefull+"?",Browser.Buttons.YES_NO)&&(sheet.getRange("CONFIG!K8").setValue("Profile1"),sheet.getRange("CONFIG!K9").setValue("EVERY HOUR"),sheet.getRange("CONFIG!K10").setValue("NIGHTLY AT 3 AM"),TriggersCreate())}function CheckAPIkey(){return""==EXKEY||""==EXSECRET?(ToastMessage("NOTIFICATION","Please enter Exchange API and Secret in CONFIG."),!1):(EXKEY=HashExkey(EXKEY,"decode"),EXSECRET=HashExkey(EXSECRET,"decode"),!0)}function HashExkey(t,r){try{if("•••••••••"!=t.substring(0,9)&&"encode"===r)return"•••••••••"+Utilities.base64Encode(t);if("•••••••••"===t.substring(0,9)&&"decode"===r)return Utilities.newBlob(Utilities.base64Decode(t.substring(9),Utilities.Charset.UTF_8)).getDataAsString()}catch(e){Logger.log("Err: API key encrypt/decrypt error. Check you API key.secret: "+t+"   "+r)}return t}function FillRAMTables(settings){function FillTable_CMCMAP(){var e=SpreadsheetApp.getActiveSpreadsheet().getSheetByName("CMC_MAPPING");return e.getRange(6,3,e.getLastRow(),4).getValues()}function FillTable_MRKDATA(settings){var result=eval(exchange+"_GetMarkets()");return null==result?("NO"==VERBOSE&&Browser.msgBox("ERROR: No Marketdata from Exchange. Please try again."),1):result}var exchange=settings.exchange;return CMCMAP=FillTable_CMCMAP(settings),CMCDATA=FillTable_CMCDATA(settings),MRKDATA=FillTable_MRKDATA(settings),CMCMAP.length<1?(DebugLog("FillRAMTables","ERROR: Initialize CMCMAP"),!1):CMCDATA.length<1?(DebugLog("FillRAMTables","ERROR: Initialize CMCDATA"),!1):MRKDATA.length<1?(DebugLog("FillRAMTables","ERROR: Initialize MRKDATA"),!1):void NormalizeMRKDATA()}function DebugLog(e,t){"ON"==DEBUG&&(""!=EXCHANGE&&null!=EXCHANGE||Browser.msgBox("ERROR: EXCHANGE is empty. Please reload sheet"),Logger.log("*********************************************************************"),Logger.log(e),Logger.log("*********************************************************************"),Logger.log(t),ToastMessage(e,t))}function GetCSVSheet(e){var t=e.exchangefull.toLowerCase()+".csv";if("no"==Browser.msgBox("Import sheet/tab : "+t+" ?\\n\\nMake sure this sheet exists (lowercase name) with data from your exchange.",Browser.Buttons.YES_NO))return null;try{var r=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(t);"BIN"==e.exchange&&(a=r.getRange(1,1,r.getLastRow(),1).setNumberFormat("@"));var a=r.getRange(1,1,r.getLastRow(),r.getLastColumn()).getValues()}catch(e){if(null==a)return ToastMessage("MESSAGE","["+t+"] not found or empty."),null}return function(e){for(var t=e.shift(),r=[],a=0;a<e.length;a++){for(var n={},s=0;s<e[a].length;s++)n[t[s]]=e[a][s];r.push(n)}return r}(a)}function CheckForUpdates(){var e=Fetch("https://sites.google.com/site/moosyresearch/projects/cryptos/botmon.json");if(null==e)return 1;var t=[];if(t.push([e.Name+" "+e.Version,"",e.Date]),t.push([e.Message,"",""]),t.push(["","",""]),t.push([e.URL,"",""]),sheet.getRange(23,10,4,3).setValues(t),sheet.getRange("CONFIG!$J$20").setValue(NAME+" "+VERSION),e.Version!=VERSION){if("YES"==e.Force2Update.toUpperCase()&&"NO"==VERBOSE)return Browser.msgBox("YOU MUST UPGRADE:\\n\\n"+e.Name+" "+e.Version+" is available.\\n\\n"+e.Message),TriggersRemove(),!1;if("YES"==e.Notification.toUpperCase()&&"NO"==VERBOSE)return Browser.msgBox("WARNING:\\nYou are not using the recommended version:\\n\\nLatest official version: "+e.Name+" "+e.Version+"\\n\\n"+e.Message),!0}return!0}function HideUnhideCols(){var e=SpreadsheetApp.getActiveSpreadsheet().getActiveSheet(),t=e.getMaxColumns(),r=e.getRange(4,1,1,t).getValues();if(1==r[0][0]){for(var a=1;a<t-2;a++)"."==r[0][a]&&e.hideColumns(a+1,1);r=0}else e.showColumns(1,t),r=1;e.getRange(4,1,1,1).setValue(r)}function ClearMatches(){if("NO"==Browser.msgBox("TESTING AND LEARNING ONLY\\n\\nThis will delete all your matching data (Col P:U) !!!\\n\\nMatching data includes prices from the moment the match was created !!\\n\\nAre you sure?",Browser.Buttons.YES_NO))return 1;var e=SpreadsheetApp.getActiveSpreadsheet().getActiveSheet(),t=e.getMaxRows();e.getRange(6,16,t,7).clearContent();FixAPIfields()}function HideCols(){var e=SpreadsheetApp.getActiveSpreadsheet().getName(),t=1==(t=e.getRange(1,1,1,1).getValues())?(e.hideColumns(7,9),0):(e.showColumns(7,9),1);e.getRange(1,1,1,1).setValue(t)}function ToastMessage(e,t){null==e&&(e="Oops ..."),null==t&&(t="Empty response"),SpreadsheetApp.getActiveSpreadsheet().toast(t,e,20)}function CapFirstLetter(e){return(e=e.toLowerCase()).charAt(0).toUpperCase()+e.slice(1)}function CalcArrayWidth(e){for(var t=[];t.push(e.length),Array.isArray(e[0]);)e=e[0];return t[1]}function isValidDate(e){var t=new Date(e);return!isNaN(t.getDate())}function LoadTick3(t,e){var r=CacheService.getScriptCache();try{var a=UrlFetchApp.fetch(t).getContentText()}catch(e){try{a=UrlFetchApp.fetch(t).getContentText()}catch(e){try{a=UrlFetchApp.fetch(t).getContentText()}catch(e){a=null}}}if(null!=a)try{return r.put(e,JSON.stringify(data),21600),data}catch(e){Logger.log("Err: Tools cache.put 2")}var n=r.get(e);return null!=n?JSON.parse(n):null}function Fetch(t,r){if(null!=r&&null!=r)try{var e=UrlFetchApp.fetch(t,r)}catch(e){return"NO"==VERBOSE&&DebugLog("Fetch Error:"+t+r,e),null}else try{e=UrlFetchApp.fetch(t)}catch(e){return"NO"==VERBOSE&&DebugLog("Fetch Error:"+t,e),null}return JSON.parse(e.getContentText())}function MigrateSheet(){function e(e,t,r){var a,n=SpreadsheetApp.getActiveSpreadsheet().getSheetByName("CONFIG"),s=SpreadsheetApp.openById(e).getSheetByName("CONFIG");"formula"==r?(a=s.getRange(t).getFormulas(),n.getRange(t).setFormulas(a)):(a=s.getRange(t).getValues(),n.getRange(t).setValues(a))}function t(e,t,r){try{DebugLog("MigrateTab",t+" "+r);var a=SpreadsheetApp.openById(g).getSheetByName(t),n=a.getLastRow(),s=a.getRange(t+"!"+r+n).getValues(),o=SpreadsheetApp.getActiveSpreadsheet().getSheetByName(t),i=a.getLastRow(),c=n-i;i<n&&sheet.insertRowsAfter(o.getLastRow()+1,c);var l=o.getRange(t+"!"+r+n);l.clearContent(),l.setValues(s)}catch(e){return void Browser.msgBox("ERROR: MigrateSheet "+t+"!"+r+n)}}var r,a,g=Browser.inputBox("Migration Assistant\\n\\n Enter Google Sheet ID of the file you like to import.",Browser.Buttons.OK_CANCEL);if("cancel"==g)return 0;g=g.trim();try{var n=SpreadsheetApp.openById(g).getSheetByName("CONFIG");r=n.getRange("CONFIG!J20").getValue(),a=r.split(" "),0==/^[0-9.,]+$/.test(a[1])?Number(a[1].substring(0,a[1].length-1)):Number(a[1])}catch(e){return Browser.msgBox("ERROR: Not a valid BotMon file. "),null}t(0,"Trades","B6:U"),t(0,"Deposits","B6:I"),t(0,"Withdrawals","B6:I"),"yes"==Browser.msgBox("Do you want to migrate your CMC_Mapping tab as well?\\n\\nWARNING: This will overwrite the CMC_Mapping table that is part of this version.",Browser.Buttons.YES_NO)&&t(0,"CMC_Mapping","C6:F"),e(g,"CONFIG!D6:D11"),e(g,"CONFIG!J27:J33"),e(g,"Unmatched!A6","formula"),Browser.msgBox("THE IMPORT WAS SUCCESSFUL:\\n\\nIMPORTANT NOTE:\\na.) You need to MANUALLY remove the Triggers from your OLD SHEET by pressing the REMOVE BUTTON in CONFIG.\\nb.) Verify and/or recreate your presonal Trigger settings for this sheet.")}function ToFiat(e,t){Logger.log("*******");var r=0;r="USD"==e?USD2FIAT:parseFloat(CMC_price(e)),e==FIAT&&(r=1);var a=r*parseFloat(t);return Logger.log("dedug : currency :"+e+"   amount:"+t+"    "+a+"   x:"+r),a}function NormalizeMarketCode(e){for(var t=0;t<MRKDATA.length;t++){if(""==MRKDATA[t][1])return e;if(MRKDATA[t][1]==e)return MRKDATA[t][0]}}function UnNormalizeMarketCode(e){for(var t=0;t<MRKDATA.length;t++)if(e==MRKDATA[t][0])return""==MRKDATA[t][1]?MRKDATA[t][0]:MRKDATA[t][1]}function NormalizeCoinCode(e,t){for(var r=0;r<CMCMAP.length;r++)if(CMCMAP[r][0]==e&&CMCMAP[r][1]==t)return CMCMAP[r][2];return t}function UnNormalizeCoinCode(e,t){for(var r=0;r<CMCMAP.length;r++){if(CMCMAP[r][0]==e)return t;if(CMCMAP[r][2]==t)return CMCMAP[r][1]}return t}function NormalizeMRKDATA(){Logger.log("Tools: NormalizeMRKDATA");for(var e=0;e<CMCMAP.length;e++)if(CMCMAP[e][0]==EXCHANGE)for(var t=0;t<MRKDATA.length;t++)try{MRKDATA[t][0]=MRKDATA[t][0].replace(CMCMAP[e][1],CMCMAP[e][2])}catch(e){Logger.log(".replace "+e)}}function CMC_price(cur,btc){if(cur==FIAT)return 1;if("btc"!=btc){for(i=0;i<CMCDATA.length;i++)if(CMCDATA[i].symbol==cur)return"USD"===FIAT||"EUR"===FIAT?eval("CMCDATA[i].price_"+FIAT.toLowerCase()):eval("CMCDATA[i].price_usd")*USD2FIAT;return 0}for(i=0;i<CMCDATA.length;i++)if(CMCDATA[i].symbol==cur)return CMCDATA[i].price_btc;return Logger.log("!WARNING2: Only EUR and USD are supported"),0}function CMC_name(e){if(""==e)return 1;for(i=0;i<CMCDATA.length;i++)if(CMCDATA[i].symbol==e)return CMCDATA[i].name;switch(e){case"EUR":return"Euro";case"USD":case"CAD":return"Dollar";case"ETF":return"Ethereum Fog";case"BTXCRD":case"CRD":return"BTX Credits";case"AUD":return"Australian Dollar";case"CNY":return"Yuan Renminbi";case"JPY":return"Japanese YEN";case"BRL":return"Brazilian real";case"CHF":return"Swiss franc";case"RUB":return"Ruble";case"HKD":return"Hong Kong Dollar";case"INR":return"Indian Rupee";case"IRR":return"Iranian Rial";case"IDR":return"Rupiah";case"ILS":return"Israeli Shekel";case"KRW":return"Korean Won";case"NOK":return"Norwegian Krone";case"SEK":return"Swedish Krona";case"DKK":return"Danish Krone";case"IRR":return"Iranian Rial";case"KWD":return"Kuwaiti Dinar";case"TRY":return"Turkish Lira";case"MXN":return"Mexican Peso";case"CZK":return"Czech Koruna";case"ISK":return"Iceland Krona";case"IRR":return"Iranian Rial";case"IQD":return"Iraqi Dinar";case"LBP":return"Lebanese Pound";case"PKR":return"Pakistan Rupee";default:return"?"}return"?"}function ResetLic(){GetLicObject("delete")}function GetLicObject(e){var t={data:null,status:!0,message:""},r={mode:"evaluation",date_start_eva:new Date,date_end_eva:new Date(+new Date+12096e5)},a=PropertiesService.getUserProperties();if(t.data=PropertiesService.getUserProperties().getProperties(),"delete"===e)return a.deleteAllProperties(),t.data=null,t;if("licensed"!=a.getProperty("mode")){if(null===a.getProperty("mode")){a.setProperties(r),t.data=PropertiesService.getUserProperties().getProperties();try{CreateLicTrigger()}catch(e){Logger.log("CreateLicTrigger not found")}}var n=new Date(t.data.date_end_eva)-new Date;t.data.dleft=Math.round(n/864e5),t.data.dleft<0&&(t.data.mode="expired",t.status=!1)}return Logger.log("License Object"),Logger.log(t.data),15<t.data.dleft&&(t.status=!1,t.message="Ava. can not be > 14"),null!=t.data.lickey&&t.data.lickey!=GenLic()&&(t.status=!1,t.message="Err: wrong user license",ResetLic()),t}function LicFileAccess(){var e={data:null,status:!0,message:""};return e}function LicValidateTrigger(){var e={data:null,status:!0,message:""};if(!0===(e=GetLicObject()).status&&"licensed"===e.data.mode)return e;e=LicFileAccess();var t,r,a;return"cancel"==(t=Browser.inputBox("Please enter your license key",Browser.Buttons.OK_CANCEL))||(t!=GenLic()?Browser.msgBox("Invalid License key, reload sheet and try again"):!0===e.status&&(r=PropertiesService.getUserProperties(),a={mode:"licensed",licdate:new Date,lickey:GenLic()},r.setProperties(a,!0))),e}function GenLic(){function init_lib(){try{var libloc="https://sites.google.com/site/moosyresearch/projects/cryptos/botmon/script34/",libraries={hashes:libloc+"hashes.gs"};function loadLIBFromUrl(url){return eval(UrlFetchApp.fetch(url).getContentText())}Object.keys(libraries).forEach(function(library){newFunc=loadLIBFromUrl(libraries[library]),eval("var "+library+" = "+newFunc)})}catch(e){return void Logger.log("Error","Could not initialize the libraries ")}}function sha_email(){var e=new jsSHA("SHA-512","TEXT");return e.update(Session.getActiveUser().getEmail()),"b90asdjhm"+e.getHash("HEX").substring(3,30)+"m0n27"}try{var lict=sha_email()}catch(e){init_lib();var lict=sha_email()}return lict}function CreateURIQueryString(n,e){switch(e){case"?":var r="?";break;case"&":r="&";break;default:r=""}try{return Object.keys(n).reduce(function(e,a,t){return e+(0==t?r:"&")+(Array.isArray(n[a])?n[a].reduce(function(e,t,r){return e+a+"="+encodeURI(t)+(r!=n[a].length-1?"&":"")},""):a+"="+encodeURI(n[a]))},"")}catch(e){return n}}